<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Community Voting Tally</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Community Ideas & Voting</h1>
    <div class="idea-form">
        <h2>Propose a New Idea</h2>
        <form id="newIdeaForm">
            <input type="text" id="ideaText" placeholder="Your idea for the community..." required style="width:70%;">
            <button type="submit">Submit Idea</button>
        </form>
    </div>
    <div class="idea-list">
        <h2>Ideas & Voting</h2>
        <button id="resetPersonalVotesBtn" style="margin-bottom:1em;">Reset My Votes</button>
        <div id="ideas"></div>
    </div>
    <script>
const API_BASE = "https://votingtally.onrender.com/"; // Use this for Render deployment
let ideas = [];

// Render ideas in the requested style
function renderIdeas() {
    const ideasDiv = document.getElementById('ideas');
    ideasDiv.innerHTML = '';
    ideas.forEach((idea, idx) => {
        ideasDiv.innerHTML += `
            <div class="idea">
                <div>${idea.text}</div>
                <div class="idea-votes-row">
                    <span class="idea-vote agree">
                        <span class="icon">üëç</span> ${idea.agree}
                    </span>
                    <span class="idea-vote disagree">
                        <span class="icon">üëé</span> ${idea.disagree}
                    </span>
                </div>
                <div class="idea-votes-row">
                    <button type="button" onclick="vote(${idx}, 'agree')" class="agree">Agree</button>
                    <button type="button" onclick="vote(${idx}, 'disagree')" class="disagree">Disagree</button>
                </div>
            </div>
        `;
    });
}

async function fetchIdeas() {
    try {
        const res = await fetch(`${API_BASE}/ideas`);
        if (!res.ok) throw new Error("Failed to fetch ideas");
        ideas = await res.json();
        renderIdeas();
    } catch (err) {
        document.getElementById('ideas').innerHTML = "<div style='color:red;'>Unable to load ideas. Please try again later.</div>";
    }
}

async function vote(idx, type) {
    try {
        await fetch(`${API_BASE}/vote`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ idx, type })
        });
        fetchIdeas();
    } catch (err) {
        alert("Network error. Please try again.");
    }
}

document.getElementById('newIdeaForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const text = document.getElementById('ideaText').value.trim();
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    if (text) {
        try {
            const res = await fetch(`${API_BASE}/ideas`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            });
            if (res.ok) {
                alert("Thank you for submitting your idea!");
                document.getElementById('ideaText').value = '';
                fetchIdeas();
            } else {
                const data = await res.json();
                alert(data.error || "Failed to submit idea.");
            }
        } catch (err) {
            alert("Network error. Please try again.");
        }
    }
    submitBtn.disabled = false;
});

document.getElementById('resetPersonalVotesBtn').onclick = async function() {
    if (confirm("Are you sure you want to reset your votes?")) {
        try {
            await fetch(`${API_BASE}/resetPersonal`, { method: 'POST' });
            fetchIdeas();
        } catch (err) {
            alert("Network error. Please try again.");
        }
    }
};

fetchIdeas();
    </script>
</body>
</html>