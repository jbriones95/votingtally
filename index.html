<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Littleton Colorado Restaurants by Cuisine</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Littleton Colorado Restaurants by Cuisine</h1>
    <div id="cuisines"></div>
  </div>
  <script>
    const restaurantsByCuisine = {
      "American": [
        { name: "Manning's Steaks & Spirits", address: "111 S. Broadway" },
        { name: "Farm House Restaurant at Breckenridge Brewery", address: "2990 Brewery Ln" },
        { name: "Grande Station", address: "2299 W Main St" }
      ],
      "Italian": [
        { name: "Angelo's Taverna - Littleton", address: "6885 S Santa Fe Dr" },
        { name: "Cafe Terracotta", address: "5649 S Curtice St" }
      ],
      "Seafood": [
        { name: "Smokin Fins - Littleton", address: "2575 W Main St" }
      ],
      "Asian": [
        { name: "Ninja Sushi", address: "7301 S Santa Fe Dr" }
      ],
      "Bar & Grill": [
        { name: "ViewHouse", address: "2680 W Main St" }
      ]
    };

    let votesData = {};

    function escapeHtml(s = '') {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function renderCuisines() {
      const cuisinesEl = document.getElementById('cuisines');
      let flatIdx = 0;
      cuisinesEl.innerHTML = Object.entries(restaurantsByCuisine).map(([cuisine, list]) => {
        // Sort by total votes (agree + disagree + pass) descending
        const sortedList = list
          .map((r, idx) => {
            const vote = votesData[flatIdx + idx] || { agree: 0, disagree: 0, pass: 0 };
            return { ...r, idx: flatIdx + idx, totalVotes: (vote.agree || 0) + (vote.disagree || 0) + (vote.pass || 0) };
          })
          .sort((a, b) => b.totalVotes - a.totalVotes);

        const html = `
          <section class="cuisine-section">
            <div class="cuisine-title">${escapeHtml(cuisine)}</div>
            <div class="restaurant-grid">
              ${sortedList.map(r => {
                const vote = votesData[r.idx] || { agree: 0, disagree: 0, pass: 0 };
                const disabled = vote.voted ? "disabled" : "";
                const votedMsg = vote.voted ? `<div style="color:#388e3c;font-size:.95em;margin-top:.5em;">You voted</div>` : "";
                return `
                  <div class="restaurant-card">
                    <div class="restaurant-name">${escapeHtml(r.name)}</div>
                    <div class="restaurant-address">${escapeHtml(r.address)}</div>
                    <div class="vote-row">
                      <button class="vote-btn agree" ${disabled} onclick="voteRestaurant(${r.idx}, 'agree')" title="Thumbs up">&#128077;</button>
                      <span class="vote-count">${vote.agree || 0}</span>
                      <button class="vote-btn disagree" ${disabled} onclick="voteRestaurant(${r.idx}, 'disagree')" title="Thumbs down">&#128078;</button>
                      <span class="vote-count">${vote.disagree || 0}</span>
                    </div>
                    ${votedMsg}
                    <button class="vote-btn" style="margin-top:0.7em;" onclick="resetVote(${r.idx})" ${!vote.voted ? "disabled" : ""} title="Reset my vote">Reset</button>
                  </div>
                `;
              }).join('')}
            </div>
          </section>
        `;
        flatIdx += list.length;
        return html;
      }).join('');
    }

    async function fetchVotes() {
      try {
        const res = await fetch('/api/food');
        if (!res.ok) throw new Error('Failed to load');
        const data = await res.json();
        votesData = {};
        data.forEach((item, idx) => {
          votesData[idx] = {
            agree: item.agreeCount || 0,
            disagree: item.disagreeCount || 0,
            pass: item.passCount || 0,
            voted: item.voted || false
          };
        });
        renderCuisines();
      } catch (err) {
        votesData = {};
        renderCuisines();
      }
    }

    window.voteRestaurant = async function(idx, type) {
      try {
        const res = await fetch('/api/food/vote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idx, type })
        });
        const data = await res.json();
        if (!res.ok) {
          alert(data.error || "Vote failed.");
        }
        await fetchVotes();
      } catch (err) {
        alert("Network error. Please try again.");
      }
    };

    window.resetVote = async function(idx) {
      try {
        const res = await fetch('/api/food/vote/reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idx })
        });
        const data = await res.json();
        if (!res.ok) {
          alert(data.error || "Reset failed.");
        }
        await fetchVotes();
      } catch (err) {
        alert("Network error. Please try again.");
      }
    };

    fetchVotes();
  </script>
</body>
</html>