<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title></title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* small page-specific tweaks (no title / no submission form) */
    .container { max-width: 800px; margin: 2.5rem auto; padding: 0 1rem; }
    .header { display:flex; justify-content:flex-end; align-items:center; gap:1rem; }
    .food-list { margin-top:1rem; }
    .hint { color:#2e7d32; cursor:pointer; background:transparent; border:none; padding:0; font-weight:500; }
    .status { margin-top:0.5rem; color:#d32f2f; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <button id="resetPersonalFoodBtn" class="hint">Reset My Votes</button>
      </div>
    </div>

    <section id="foods" class="food-list" aria-live="polite"></section>
    <div id="status" class="status" role="status" aria-atomic="true"></div>
  </div>

  <script>
    // Use relative paths so this page works when served from the food server root or same origin.
    const API_SUGGEST = "/api/food";
    const API_VOTE = "/api/food/vote";
    const API_RESET_PERSONAL = "/api/food/resetPersonal";

    const foodsEl = document.getElementById('foods');
    const statusEl = document.getElementById('status');

    function showStatus(msg, color = '#d32f2f') {
      statusEl.textContent = msg || '';
      statusEl.style.color = color;
      if (msg) setTimeout(() => { statusEl.textContent = ''; }, 6000);
    }

    function renderFoods(list) {
      if (!Array.isArray(list) || list.length === 0) {
        foodsEl.innerHTML = '<div style="color:#555">No suggestions yet.</div>';
        return;
      }
      foodsEl.innerHTML = list.map((f, idx) => `
        <article class="idea" style="padding:1.2rem 1.4rem;">
          <div style="margin-bottom:.9rem;">${escapeHtml(f.text)}</div>

          <div class="idea-votes-row" style="gap:1.6rem; margin-bottom:.6rem;">
            <div class="idea-vote agree">üëç <strong style="margin-left:.35rem;">${f.agreeCount ?? 0}</strong></div>
            <div class="idea-vote disagree">üëé <strong style="margin-left:.35rem;">${f.disagreeCount ?? 0}</strong></div>
            <div class="idea-vote pass" style="color:#666">PASS <strong style="margin-left:.35rem;">${f.passCount ?? 0}</strong></div>
          </div>

          <div class="idea-votes-row">
            <button type="button" onclick="vote(${idx}, 'agree')" class="agree">Agree</button>
            <button type="button" onclick="vote(${idx}, 'disagree')" class="disagree">Disagree</button>
            <button type="button" onclick="vote(${idx}, 'pass')" class="pass">Pass</button>
          </div>
        </article>
      `).join('');
    }

    function escapeHtml(s = '') {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    async function fetchFoods() {
      try {
        const res = await fetch(API_SUGGEST);
        if (!res.ok) throw new Error('Failed to load');
        const data = await res.json();
        // client-side safety: sort by total votes (descending)
        data.sort((a, b) => ((b.agreeCount||0) + (b.disagreeCount||0) + (b.passCount||0)) - ((a.agreeCount||0) + (a.disagreeCount||0) + (a.passCount||0)));
        renderFoods(data);
      } catch (err) {
        renderFoods([]);
        showStatus('Unable to load suggestions. Please try again later.');
      }
    }

    async function vote(idx, type) {
      try {
        const res = await fetch(API_VOTE, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ idx, type })
        });
        if (!res.ok) {
          const body = await res.json().catch(()=>({}));
          showStatus(body.error || 'Vote failed');
        }
        await fetchFoods();
      } catch (err) {
        showStatus('Network error. Please try again.');
      }
    }

    document.getElementById('resetPersonalFoodBtn').addEventListener('click', async () => {
      if (!confirm('Reset your votes?')) return;
      try {
        const res = await fetch(API_RESET_PERSONAL, { method: 'POST' });
        if (!res.ok) showStatus('Reset failed');
        else {
          showStatus('Your votes were reset.', '#2e7d32');
          await fetchFoods();
        }
      } catch (err) {
        showStatus('Network error. Please try again.');
      }
    });

    // initial load
    fetchFoods();
  </script>
</body>
</html>